!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Pico8Reader={})}(this,(function(e){"use strict";let t=[],n=0;function r(e,t){const n=Math.ceil(t/e.length);return e.repeat(n).slice(0,t)}function o(){const e=t[n];return n+=1,e}function i(e){const r=t.slice(n,n+e).reverse().join("");return n+=e,r}let s=0;function c(e,t){const n=t.length;if(e.length<n)return!1;for(let r=0;r<n;r++)if(e[r]!==t[r])return!1;return!0}function f(e){const f=e.slice(17152,32768),l=c(f,new Uint8Array([0,112,120,97])),a=c(f,new Uint8Array([58,99,58,0])),u=f.slice(4);if(l){return function(e){const s=e[0]<<8|e[1],c=[];for(let e=0;e<256;e++)c.push(e);const f=e.slice(4);t=[];for(let e=0;e<f.length;e++){const n=f[e].toString(2).padStart(8,"0").split("").reverse();t.push(...n)}let l="";for(n=0;l.length<s;)if("1"===o()){let e=0;for(;"1"===o();)e+=1;const t=(1<<e)-1,n=i(e+4),r=parseInt(n,2)+(t<<4);l+=String.fromCharCode(c[r]);const s=c.splice(r,1);c.unshift(s[0])}else{let e;e="1"===o()?"1"===o()?5:10:15;const t=i(e),n=parseInt(t,2)+1;let s=3;for(;;){const e=i(3),t=parseInt(e,2);if(s+=t,7!==t)break}if(n>l.length)throw console.warn("offset 大于 code 长度",n,l.length,l),new Error("offset 大于 code 长度");let c="";c=s>=n?l.slice(-n):l.slice(-n,-n+s),s>n&&(c+=r(c,s-n)),l+=c}return l}(u)}if(a){return function(e){const t=e[0]<<8|e[1],n=e.slice(4);let r="";for(s=0;r.length<t;){const e=n[s];if(0===e)r+=String.fromCharCode(n[s+1]),s+=2;else if(e<=59)r+="\n 0123456789abcdefghijklmnopqrstuvwxyz!#%(){}[]<>+=/*:;.,~_"[e-1],s++;else{const t=n[s+1],o=16*(e-60)+(15&t),i=2+(t>>4),c=r.length-o,f=r.slice(c,c+i);r+=f,s+=2}}return r}(u)}return function(e){let t="";for(let n=0;n<e.length;n++){const r=e[n];0!==r&&(t+=String.fromCharCode(r))}return t}(f)}e.readP8=async function(e){var t;return{asset:undefined,code:f(function(e){const t=new Uint8Array(e.length/4);for(let n=0;n<e.length;n+=4){const r=3&e[n],o=3&e[n+1],i=3&e[n+2],s=(3&e[n+3])<<6|r<<4|o<<2|i;t[n/4]=s}return t}(await(t=e,new Promise(((e,n)=>{const r=new Image;r.onload=()=>{const t=document.createElement("canvas"),n=t.getContext("2d");t.width=r.width,t.height=r.height,n.drawImage(r,0,0);const o=n.getImageData(0,0,t.width,t.height).data;e(o)},r.onerror=()=>{n(new Error("无法加载图片"))},r.src=t})))))}}}));
